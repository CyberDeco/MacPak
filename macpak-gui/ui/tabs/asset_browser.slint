import { Button, VerticalBox, HorizontalBox, LineEdit, ScrollView, ComboBox } from "std-widgets.slint";
import { FileEntry, QuickFilterButton, FileRow, ContextMenu } from "../components/common.slint";

// ============================================================================
// Asset Browser Tab
// ============================================================================
export component AssetBrowserTab inherits VerticalBox {
    // Path and navigation
    in-out property <string> current-path: "";

    // File list
    in property <[FileEntry]> files: [];
    in-out property <int> selected-index: -1;

    // Filtering
    in-out property <string> search-text: "";
    in-out property <int> type-filter-index: 0;
    in-out property <bool> filter-pak: false;
    in-out property <bool> filter-larian: false;
    in-out property <bool> filter-images: false;
    in-out property <bool> filter-models: false;
    in-out property <bool> filter-scripts: false;
    in-out property <bool> filter-audio: false;
    in-out property <bool> filter-effects: false;

    // Statistics
    in-out property <int> file-count: 0;
    in-out property <int> folder-count: 0;
    in-out property <int> visible-count: 0;
    in-out property <string> total-size: "0 B";

    // Preview
    in-out property <string> preview-content: "";
    in-out property <string> preview-file-name: "";
    in-out property <string> preview-file-info: "";

    // Context menu state
    in-out property <bool> context-menu-visible: false;
    in-out property <length> context-menu-x: 0px;
    in-out property <length> context-menu-y: 0px;
    in-out property <string> context-menu-file-path: "";
    in-out property <string> context-menu-file-type: "";
    in-out property <bool> context-menu-is-dir: false;

    // Callbacks
    callback open-folder();
    callback go-up();
    callback go-to-path(string);
    callback refresh();
    callback clear-cache();
    callback file-selected(int);
    callback file-double-clicked(int);
    callback search-changed(string);
    callback filter-changed(int);
    callback toggle-filter(string);
    callback copy-path(string);
    callback show-in-finder(string);
    callback open-in-editor(string);
    callback quick-convert(string, string);  // (file-path, conversion-type)
    callback context-menu-action(string, string);  // (action, file-path)

    padding: 0px;
    spacing: 0px;

    // Header
    Rectangle {
        background: white;
        height: 56px;

        HorizontalBox {
            padding: 14px;
            padding-left: 20px;
            padding-right: 20px;

            Text {
                text: "Asset Browser";
                font-size: 22px;
                font-weight: 700;
                color: #1d1d1f;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Text {
                text: "Browse and preview game assets";
                font-size: 13px;
                color: #888888;
                vertical-alignment: center;
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Navigation bar
    Rectangle {
        background: white;
        height: 50px;

        HorizontalBox {
            padding: 10px;
            padding-left: 16px;
            padding-right: 16px;
            spacing: 8px;

            Button {
                text: "‚¨Ü Up";
                enabled: root.current-path != "";
                clicked => { root.go-up(); }
            }

            LineEdit {
                horizontal-stretch: 1;
                text <=> root.current-path;
                placeholder-text: "Enter path or click Browse to open a folder...";
                accepted => {
                    root.go-to-path(root.current-path);
                }
            }

            Button {
                text: "üìÇ Browse";
                clicked => { root.open-folder(); }
                primary: root.current-path == "";
            }

            Button {
                text: "üîÑ Refresh";
                enabled: root.current-path != "";
                clicked => { root.refresh(); }
            }

            Button {
                text: "üóë Clear Cache";
                clicked => { root.clear-cache(); }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Filter bar
    Rectangle {
        background: white;
        height: 90px;

        VerticalBox {
            padding: 8px;
            padding-left: 16px;
            padding-right: 16px;
            padding-top: 3px;
            spacing: 6px;

            // Search and type filter row
            HorizontalBox {
                spacing: 10px;

                Text {
                    text: "üîç";
                    font-size: 16px;
                    vertical-alignment: center;
                }

                LineEdit {
                    placeholder-text: "Search files...";
                    text <=> root.search-text;
                    horizontal-stretch: 1;
                    edited => { root.search-changed(root.search-text); }
                }

                Text {
                    text: "Type:";
                    font-size: 13px;
                    font-weight: 600;
                    color: #666666;
                    vertical-alignment: center;
                }

                ComboBox {
                    model: ["All Files", "PAK Files", "LSF Files", "LSX Files", "LSJ Files", "DDS Images", "Models (.gr2)", "Audio", "Localization"];
                    current-index <=> root.type-filter-index;
                    width: 150px;
                    selected => { root.filter-changed(root.type-filter-index); }
                }

                Button {
                    text: "Clear";
                    clicked => {
                        root.search-text = "";
                        root.type-filter-index = 0;
                        root.filter-pak = false;
                        root.filter-larian = false;
                        root.filter-images = false;
                        root.filter-models = false;
                        root.filter-scripts = false;
                        root.filter-audio = false;
                        root.filter-effects = false;
                        root.search-changed("");
                    }
                }
            }

            // Quick filter buttons row
            HorizontalBox {
                spacing: 6px;

                Text {
                    text: "Quick Filter:";
                    font-size: 11px;
                    font-weight: 600;
                    color: #666666;
                    vertical-alignment: center;
                }

                QuickFilterButton {
                    label: "üì¶ PAK";
                    active: root.filter-pak;
                    clicked => {
                        root.filter-pak = !root.filter-pak;
                        root.toggle-filter("pak");
                    }
                }

                QuickFilterButton {
                    label: "üìÑ Binary Files";
                    active: root.filter-larian;
                    clicked => {
                        root.filter-larian = !root.filter-larian;
                        root.toggle-filter("larian");
                    }
                }

                QuickFilterButton {
                    label: "üñºÔ∏è Images";
                    active: root.filter-images;
                    clicked => {
                        root.filter-images = !root.filter-images;
                        root.toggle-filter("images");
                    }
                }

                QuickFilterButton {
                    label: "üñåÔ∏è Models";
                    active: root.filter-models;
                    clicked => {
                        root.filter-models = !root.filter-models;
                        root.toggle-filter("models");
                    }
                }

                QuickFilterButton {
                    label: "üìú Scripts";
                    active: root.filter-scripts;
                    clicked => {
                        root.filter-scripts = !root.filter-scripts;
                        root.toggle-filter("scripts");
                    }
                }

                QuickFilterButton {
                    label: "üîä Audio";
                    active: root.filter-audio;
                    clicked => {
                        root.filter-audio = !root.filter-audio;
                        root.toggle-filter("audio");
                    }
                }

                QuickFilterButton {
                    label: "‚ú® Effects";
                    active: root.filter-effects;
                    clicked => {
                        root.filter-effects = !root.filter-effects;
                        root.toggle-filter("effects");
                    }
                }

                Rectangle { horizontal-stretch: 1; }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Main content area
    HorizontalLayout {
        vertical-stretch: 1;

        // File list with header
        VerticalLayout {
            horizontal-stretch: 3;
            min-width: 500px;

            // Column headers
            Rectangle {
                background: #f5f5f5;
                height: 34px;

                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 12px;

                    // Icon spacer
                    Rectangle { width: 26px; }

                    // Name header with sort indicator
                    HorizontalBox {
                        horizontal-stretch: 1;
                        spacing: 4px;

                        Text {
                            text: "NAME";
                            font-size: 11px;
                            font-weight: 700;
                            color: #555555;
                            letter-spacing: 0.5px;
                            vertical-alignment: center;
                        }

                        Text {
                            text: "‚ñ≤";
                            font-size: 9px;
                            color: #888888;
                            vertical-alignment: center;
                        }
                    }

                    // Type header
                    Text {
                        text: "TYPE";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 60px;
                        horizontal-alignment: center;
                    }

                    // Size header
                    Text {
                        text: "SIZE";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 80px;
                        horizontal-alignment: right;
                    }

                    // Modified header
                    Text {
                        text: "MODIFIED";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 120px;
                    }
                }
            }

            Rectangle { height: 1px; background: #e0e0e0; }

            // File list with keyboard navigation
            Rectangle {
                background: #ffffff;
                vertical-stretch: 1;

                file-focus := FocusScope {
                    width: 100%;
                    height: 100%;

                    key-pressed(event) => {
                        if (event.text == Key.UpArrow) {
                            if root.selected-index > 0 {
                                root.selected-index = root.selected-index - 1;
                                root.file-selected(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.DownArrow) {
                            if root.selected-index < root.files.length - 1 {
                                root.selected-index = root.selected-index + 1;
                                root.file-selected(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.Return) {
                            if root.selected-index >= 0 && root.selected-index < root.files.length {
                                root.file-double-clicked(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.Escape) {
                            // Close context menu first, then deselect
                            if root.context-menu-visible {
                                root.context-menu-visible = false;
                            } else {
                                root.selected-index = -1;
                            }
                            return accept;
                        }
                        return reject;
                    }
                }

                if root.files.length == 0 : VerticalLayout {
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: root.current-path == "" ? "üìÅ" : "üìÇ";
                        font-size: 48px;
                        horizontal-alignment: center;
                        color: #cccccc;
                    }

                    Text {
                        text: root.current-path == "" ? "Select a folder to browse" : "No files in this directory";
                        color: #999999;
                        font-size: 14px;
                        horizontal-alignment: center;
                    }

                    if root.current-path == "" : Text {
                        text: "Click \"Browse\" to open a folder";
                        color: #bbbbbb;
                        font-size: 12px;
                        horizontal-alignment: center;
                    }
                }

                if root.files.length > 0 : ScrollView {
                    VerticalLayout {
                        alignment: start;

                        for file[idx] in root.files : FileRow {
                            entry: file;
                            selected: idx == root.selected-index;
                            alternate: mod(idx, 2) == 1;
                            clicked => {
                                root.selected-index = idx;
                                root.file-selected(idx);
                                file-focus.focus();
                                // Close context menu on regular click
                                root.context-menu-visible = false;
                            }
                            double-clicked => {
                                root.file-double-clicked(idx);
                            }
                            right-clicked(x, y) => {
                                // Select the file first
                                root.selected-index = idx;
                                root.file-selected(idx);
                                // Show context menu at click position
                                root.context-menu-file-path = file.full-path;
                                root.context-menu-file-type = file.file-type;
                                root.context-menu-is-dir = file.is-dir;
                                root.context-menu-x = self.x + x;
                                root.context-menu-y = self.y + y;
                                root.context-menu-visible = true;
                            }
                        }
                    }
                }

                // Context menu overlay
                ContextMenu {
                    show-menu: root.context-menu-visible;
                    menu-x: root.context-menu-x;
                    menu-y: root.context-menu-y;
                    file-path: root.context-menu-file-path;
                    file-type: root.context-menu-file-type;
                    is-directory: root.context-menu-is-dir;
                    close => {
                        root.context-menu-visible = false;
                    }
                    action-open => {
                        root.file-double-clicked(root.selected-index);
                    }
                    action-open-with => {
                        root.open-in-editor(root.context-menu-file-path);
                    }
                    action-show-in-finder => {
                        root.show-in-finder(root.context-menu-file-path);
                    }
                    action-copy-path => {
                        root.copy-path(root.context-menu-file-path);
                    }
                    action-convert-lsx => {
                        if root.context-menu-file-type == "LSF" {
                            root.quick-convert(root.context-menu-file-path, "lsf-to-lsx");
                        } else if root.context-menu-file-type == "LSJ" {
                            root.quick-convert(root.context-menu-file-path, "lsj-to-lsx");
                        }
                    }
                    action-convert-lsf => {
                        if root.context-menu-file-type == "LSX" {
                            root.quick-convert(root.context-menu-file-path, "lsx-to-lsf");
                        } else if root.context-menu-file-type == "LSJ" {
                            root.quick-convert(root.context-menu-file-path, "lsj-to-lsf");
                        }
                    }
                    action-convert-lsj => {
                        if root.context-menu-file-type == "LSF" {
                            root.quick-convert(root.context-menu-file-path, "lsf-to-lsj");
                        } else if root.context-menu-file-type == "LSX" {
                            root.quick-convert(root.context-menu-file-path, "lsx-to-lsj");
                        }
                    }
                    action-delete => {
                        root.context-menu-action("delete", root.context-menu-file-path);
                    }
                }
            }
        }

        Rectangle { width: 1px; background: #e0e0e0; }

        // Preview pane
        VerticalLayout {
            horizontal-stretch: 1;
            min-width: 320px;

            // Preview header
            Rectangle {
                background: #f5f5f5;
                height: 44px;

                HorizontalLayout {
                    padding: 10px;
                    padding-left: 14px;
                    padding-right: 14px;
                    spacing: 10px;

                    Text {
                        text: "Preview";
                        font-size: 14px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }

                    Rectangle { horizontal-stretch: 1; }

                    if root.preview-file-name != "" : HorizontalBox {
                        spacing: 8px;

                        Button {
                            text: "üìã Copy";
                            clicked => {
                                if root.selected-index >= 0 && root.selected-index < root.files.length {
                                    root.copy-path(root.files[root.selected-index].full-path);
                                }
                            }
                        }

                        Button {
                            text: "üìÇ Show";
                            clicked => {
                                if root.selected-index >= 0 && root.selected-index < root.files.length {
                                    root.show-in-finder(root.files[root.selected-index].full-path);
                                }
                            }
                        }
                    }
                }
            }

            Rectangle { height: 1px; background: #e0e0e0; }

            // File info
            if root.preview-file-name != "" : Rectangle {
                background: #fafafa;
                height: 56px;

                HorizontalLayout {
                    padding: 10px;
                    padding-left: 14px;
                    padding-right: 14px;

                    VerticalBox {
                        spacing: 2px;
                        horizontal-stretch: 1;

                        Text {
                            text: root.preview-file-name;
                            font-size: 13px;
                            font-weight: 600;
                            overflow: elide;
                        }

                        Text {
                            text: root.preview-file-info;
                            font-size: 11px;
                            color: #666666;
                        }
                    }
                }
            }

            // Quick Convert bar - shown for convertible files
            if root.selected-index >= 0 && root.selected-index < root.files.length : Rectangle {
                property <string> selected-type: root.files[root.selected-index].file-type;
                property <string> selected-path: root.files[root.selected-index].full-path;
                property <bool> is-lsf: selected-type == "LSF";
                property <bool> is-lsx: selected-type == "LSX";
                property <bool> is-lsj: selected-type == "LSJ";
                property <bool> show-convert: is-lsf || is-lsx || is-lsj;

                background: #f0f8ff;
                height: show-convert ? 36px : 0px;
                visible: show-convert;

                HorizontalBox {
                    padding: 6px;
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 8px;

                    Text {
                        text: "Quick Convert:";
                        font-size: 11px;
                        font-weight: 600;
                        color: #666666;
                        vertical-alignment: center;
                    }

                    // LSF -> LSX
                    if is-lsf : Button {
                        text: "‚Üí LSX";
                        clicked => { root.quick-convert(selected-path, "lsf-to-lsx"); }
                    }
                    // LSF -> LSJ
                    if is-lsf : Button {
                        text: "‚Üí LSJ";
                        clicked => { root.quick-convert(selected-path, "lsf-to-lsj"); }
                    }
                    // LSX -> LSF
                    if is-lsx : Button {
                        text: "‚Üí LSF";
                        clicked => { root.quick-convert(selected-path, "lsx-to-lsf"); }
                    }
                    // LSX -> LSJ
                    if is-lsx : Button {
                        text: "‚Üí LSJ";
                        clicked => { root.quick-convert(selected-path, "lsx-to-lsj"); }
                    }
                    // LSJ -> LSX
                    if is-lsj : Button {
                        text: "‚Üí LSX";
                        clicked => { root.quick-convert(selected-path, "lsj-to-lsx"); }
                    }
                    // LSJ -> LSF
                    if is-lsj : Button {
                        text: "‚Üí LSF";
                        clicked => { root.quick-convert(selected-path, "lsj-to-lsf"); }
                    }

                    Rectangle { horizontal-stretch: 1; }
                }
            }

            if root.preview-file-name != "" : Rectangle { height: 1px; background: #e0e0e0; }

            // Preview content
            Rectangle {
                background: white;
                vertical-stretch: 1;

                if root.preview-content == "" && root.preview-file-name == "" : VerticalLayout {
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: "üìÑ";
                        font-size: 48px;
                        horizontal-alignment: center;
                        color: #cccccc;
                    }

                    Text {
                        text: "Select a file to preview";
                        color: #999999;
                        font-size: 14px;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Click on a file in the list to see its contents";
                        color: #bbbbbb;
                        font-size: 12px;
                        horizontal-alignment: center;
                    }
                }

                if root.preview-content != "" : ScrollView {
                    VerticalBox {
                        padding: 14px;

                        Text {
                            text: root.preview-content;
                            font-size: 12px;
                            wrap: word-wrap;
                            font-family: "monospace";
                        }
                    }
                }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Status bar
    Rectangle {
        background: #f8f8f8;
        height: 32px;

        HorizontalBox {
            padding-left: 20px;
            padding-right: 20px;
            spacing: 8px;

            // Items shown count
            Text {
                text: root.visible-count + " items shown";
                font-size: 12px;
                color: #555555;
                vertical-alignment: center;
            }

            if root.visible-count != root.file-count + root.folder-count : Text {
                text: "(" + root.file-count + " files, " + root.folder-count + " folders total)";
                font-size: 12px;
                color: #888888;
                vertical-alignment: center;
            }

            // Separator
            Text {
                text: "|";
                font-size: 12px;
                color: #cccccc;
                vertical-alignment: center;
            }

            // Total size
            Text {
                text: "Total: " + root.total-size;
                font-size: 12px;
                color: #555555;
                font-weight: 500;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            // Filter indicator
            if root.filter-pak || root.filter-larian || root.filter-images || root.filter-models || root.filter-scripts || root.filter-audio || root.filter-effects : Rectangle {
                background: #e7f3ff;
                border-radius: 10px;
                height: 22px;
                width: filter-text.preferred-width + 16px;

                filter-text := Text {
                    text: "‚óè Filters active";
                    font-size: 11px;
                    color: #007AFF;
                    font-weight: 600;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
            }
        }
    }
}
