import { Button, VerticalBox, HorizontalBox, LineEdit, TextEdit, CheckBox } from "std-widgets.slint";

// ============================================================================
// Universal Editor Tab
// ============================================================================
export component UniversalEditorTab inherits VerticalBox {
    in-out property <string> file-path: "";
    in-out property <string> content: "";
    in-out property <bool> modified: false;
    in-out property <bool> converting: false;
    in-out property <string> file-format: "";
    in-out property <string> status-message: "";

    // Search state
    in-out property <bool> search-visible: false;
    in-out property <string> search-text: "";
    in-out property <string> replace-text: "";
    in-out property <bool> search-case-sensitive: false;
    in-out property <bool> search-whole-words: false;
    in-out property <bool> search-use-regex: false;
    in-out property <int> search-match-count: 0;
    in-out property <int> search-current-match: 0;
    in-out property <string> search-status: "";

    callback open();
    callback save();
    callback save-as();
    callback convert(string);
    callback content-changed(string);

    // Search callbacks
    callback toggle-search();
    callback find-next();
    callback find-previous();
    callback replace-current();
    callback replace-all();
    callback search-text-changed(string);

    padding: 0px;
    spacing: 0px;

    // Toolbar
    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        height: 50px;

        Button {
            text: "Open";
            clicked => { root.open(); }
        }
        Button {
            text: "Save";
            clicked => { root.save(); }
            enabled: root.modified;
        }
        Button {
            text: "Save As...";
            clicked => { root.save-as(); }
            enabled: root.file-path != "";
        }

        Rectangle { width: 1px; height: 30px; background: #dddddd; }

        Button {
            text: root.search-visible ? "Hide Find" : "Find";
            clicked => { root.toggle-search(); }
        }

        Rectangle { horizontal-stretch: 1; }

        if root.modified : Rectangle {
            background: #fff3cd;
            border-radius: 4px;
            width: 80px;

            Text {
                text: "Modified";
                font-size: 12px;
                color: #856404;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        if root.file-format != "" : Rectangle {
            background: #e7f3ff;
            border-radius: 4px;
            width: 60px;

            Text {
                text: root.file-format;
                font-size: 12px;
                color: #0056b3;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Conversion toolbar
    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        height: 50px;

        Text {
            text: "Convert:";
            vertical-alignment: center;
            font-weight: 600;
        }

        Button {
            text: "LSF → LSX";
            clicked => { root.convert("lsf-to-lsx"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSX → LSF";
            clicked => { root.convert("lsx-to-lsf"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSX → LSJ";
            clicked => { root.convert("lsx-to-lsj"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSJ → LSX";
            clicked => { root.convert("lsj-to-lsx"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSF → LSJ";
            clicked => { root.convert("lsf-to-lsj"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSJ → LSF";
            clicked => { root.convert("lsj-to-lsf"); }
            enabled: !root.converting;
        }

        if root.converting : Text {
            text: "Converting...";
            color: #666666;
            vertical-alignment: center;
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Search widget (collapsible)
    if root.search-visible : Rectangle {
        background: #f8f9fa;
        height: search-layout.preferred-height + 16px;

        search-layout := VerticalLayout {
            padding: 8px;
            padding-left: 12px;
            padding-right: 12px;
            spacing: 8px;

            // Find row
            HorizontalLayout {
                spacing: 8px;
                height: 32px;

                Text {
                    text: "Find:";
                    font-size: 12px;
                    font-weight: 600;
                    width: 60px;
                    vertical-alignment: center;
                }

                LineEdit {
                    text <=> root.search-text;
                    placeholder-text: "Search text...";
                    horizontal-stretch: 1;
                    edited => { root.search-text-changed(root.search-text); }
                    accepted => { root.find-next(); }
                }

                Button {
                    text: "Previous";
                    clicked => { root.find-previous(); }
                    enabled: root.search-text != "";
                }

                Button {
                    text: "Next";
                    clicked => { root.find-next(); }
                    enabled: root.search-text != "";
                }

                // Match count badge
                if root.search-text != "" : Rectangle {
                    background: root.search-match-count > 0 ? #d4edda : #f8d7da;
                    border-radius: 4px;
                    width: match-count-text.preferred-width + 16px;
                    height: 26px;

                    match-count-text := Text {
                        text: root.search-match-count > 0
                            ? (root.search-current-match + "/" + root.search-match-count)
                            : "No matches";
                        font-size: 11px;
                        color: root.search-match-count > 0 ? #155724 : #721c24;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }

            // Replace row
            HorizontalLayout {
                spacing: 8px;
                height: 32px;

                Text {
                    text: "Replace:";
                    font-size: 12px;
                    font-weight: 600;
                    width: 60px;
                    vertical-alignment: center;
                }

                LineEdit {
                    text <=> root.replace-text;
                    placeholder-text: "Replace with...";
                    horizontal-stretch: 1;
                    accepted => { root.replace-current(); }
                }

                Button {
                    text: "Replace";
                    clicked => { root.replace-current(); }
                    enabled: root.search-text != "" && root.search-match-count > 0;
                }

                Button {
                    text: "Replace All";
                    clicked => { root.replace-all(); }
                    enabled: root.search-text != "" && root.search-match-count > 0;
                }
            }

            // Options row
            HorizontalLayout {
                spacing: 16px;
                height: 28px;

                Text {
                    text: "Options:";
                    font-size: 12px;
                    font-weight: 600;
                    width: 60px;
                    vertical-alignment: center;
                }

                HorizontalLayout {
                    spacing: 6px;

                    CheckBox {
                        text: "Case sensitive";
                        checked <=> root.search-case-sensitive;
                        toggled => { root.search-text-changed(root.search-text); }
                    }
                }

                HorizontalLayout {
                    spacing: 6px;

                    CheckBox {
                        text: "Whole words";
                        checked <=> root.search-whole-words;
                        toggled => { root.search-text-changed(root.search-text); }
                    }
                }

                HorizontalLayout {
                    spacing: 6px;

                    CheckBox {
                        text: "Regex";
                        checked <=> root.search-use-regex;
                        toggled => { root.search-text-changed(root.search-text); }
                    }
                }

                Rectangle { horizontal-stretch: 1; }

                if root.search-status != "" : Text {
                    text: root.search-status;
                    font-size: 11px;
                    color: #666666;
                    vertical-alignment: center;
                }

                // Close button
                Rectangle {
                    width: 24px;
                    height: 24px;
                    border-radius: 4px;
                    background: close-touch.has-hover ? #e0e0e0 : transparent;

                    close-touch := TouchArea {
                        clicked => { root.toggle-search(); }
                    }

                    Text {
                        text: "✕";
                        font-size: 14px;
                        color: #666666;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }

    if root.search-visible : Rectangle { height: 1px; background: #dddddd; }

    // Editor content
    Rectangle {
        background: #f8f8f8;
        vertical-stretch: 1;

        VerticalLayout {
            TextEdit {
                text <=> root.content;
                font-size: 13px;
                vertical-stretch: 1;
                edited => {
                    root.modified = true;
                    // Sync content back to parent
                    root.content-changed(root.content);
                    // Re-search when content changes
                    if root.search-visible && root.search-text != "" {
                        root.search-text-changed(root.search-text);
                    }
                }
            }
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Status bar
    HorizontalBox {
        padding: 8px;
        padding-left: 12px;
        height: 32px;

        Text {
            text: root.file-path == "" ? "No file loaded" : root.file-path;
            font-size: 12px;
            color: #666666;
            vertical-alignment: center;
            overflow: elide;
            horizontal-stretch: 1;
        }

        if root.status-message != "" : Text {
            text: root.status-message;
            font-size: 12px;
            color: #28a745;
            vertical-alignment: center;
        }
    }
}
