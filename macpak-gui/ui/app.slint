import { Button, VerticalBox, HorizontalBox, TabWidget, LineEdit, TextEdit, ListView, ScrollView, StandardButton, ProgressIndicator, ComboBox, Slider, SpinBox, CheckBox } from "std-widgets.slint";

// ============================================================================
// File Entry struct for Asset Browser
// ============================================================================
export struct FileEntry {
    name: string,
    file-type: string,
    size: string,
    modified: string,
    is-dir: bool,
    full-path: string,
    icon: string,
}

// ============================================================================
// Quick Filter Button Component
// ============================================================================
component QuickFilterButton inherits Rectangle {
    in property <string> label;
    in property <bool> active: false;
    callback clicked();

    background: root.active ? #007AFF : #e8e8e8;
    border-radius: 4px;
    height: 26px;
    border-width: 1px;
    border-color: root.active ? #0066dd : #d0d0d0;

    TouchArea {
        width: 100%;
        height: 100%;
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        alignment: center;
        padding-left: 10px;
        padding-right: 10px;

        Text {
            text: root.label;
            color: root.active ? white : #333333;
            font-size: 11px;
            font-weight: 500;
            vertical-alignment: center;
        }
    }
}


// ============================================================================
// File Row Component
// ============================================================================
component FileRow inherits Rectangle {
    in property <FileEntry> entry;
    in property <bool> selected: false;
    in property <bool> alternate: false;
    callback clicked();
    callback double-clicked();
    callback right-clicked(length, length);  // x, y coordinates for context menu

    height: 34px;
    background: root.selected ? #007AFF : (touch.has-hover ? #e8f4fd : (root.alternate ? #fafafa : white));
    border-radius: root.selected ? 4px : 0px;

    touch := TouchArea {
        width: 100%;
        height: 100%;
        clicked => { root.clicked(); }
        double-clicked => { root.double-clicked(); }
        pointer-event(event) => {
            if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                root.right-clicked(touch.mouse-x, touch.mouse-y);
            }
        }
    }

    HorizontalLayout {
        padding-left: 12px;
        padding-right: 12px;
        spacing: 12px;

        // Icon
        Text {
            text: root.entry.icon;
            font-size: 16px;
            vertical-alignment: center;
            width: 26px;
            horizontal-alignment: center;
        }

        // Name column (flexible)
        Text {
            text: root.entry.name;
            color: root.selected ? white : (root.entry.is-dir ? #1d1d1f : #333333);
            font-weight: root.entry.is-dir ? 700 : 400;
            font-size: 13px;
            vertical-alignment: center;
            overflow: elide;
            horizontal-stretch: 1;
        }

        // Type column
        Text {
            text: root.entry.file-type;
            color: root.selected ? white : #666666;
            font-size: 12px;
            vertical-alignment: center;
            width: 60px;
            horizontal-alignment: center;
        }

        // Size column
        Text {
            text: root.entry.size;
            color: root.selected ? white : #666666;
            font-size: 12px;
            vertical-alignment: center;
            width: 80px;
            horizontal-alignment: right;
        }

        // Modified column
        Text {
            text: root.entry.modified;
            color: root.selected ? white : #666666;
            font-size: 12px;
            vertical-alignment: center;
            width: 120px;
        }
    }
}

// ============================================================================
// Context Menu Item Component
// ============================================================================
component ContextMenuItem inherits Rectangle {
    in property <string> label;
    in property <string> icon: "";
    in property <bool> enabled: true;
    in property <bool> is-separator: false;
    callback clicked();

    height: root.is-separator ? 9px : 28px;
    background: root.is-separator ? transparent : (touch.has-hover && root.enabled ? #007AFF : transparent);
    border-radius: 4px;

    // Separator line (only visible for separator items)
    Rectangle {
        visible: root.is-separator;
        y: 4px;
        height: 1px;
        background: #e0e0e0;
    }

    // Interactive touch area (always present but disabled for separators)
    touch := TouchArea {
        width: 100%;
        height: 100%;
        enabled: root.enabled && !root.is-separator;
        clicked => { root.clicked(); }
        mouse-cursor: root.enabled && !root.is-separator ? pointer : default;
    }

    // Content layout (hidden for separators)
    HorizontalLayout {
        visible: !root.is-separator;
        padding-left: 10px;
        padding-right: 10px;
        spacing: 8px;

        Text {
            text: root.icon;
            font-size: 13px;
            vertical-alignment: center;
            width: 20px;
            opacity: root.enabled ? 1.0 : 0.4;
        }

        Text {
            text: root.label;
            font-size: 13px;
            color: touch.has-hover && root.enabled ? white : (root.enabled ? #333333 : #999999);
            vertical-alignment: center;
            horizontal-stretch: 1;
        }
    }
}

// ============================================================================
// Context Menu Component
// ============================================================================
component ContextMenu inherits Rectangle {
    in property <bool> show-menu: false;
    in property <length> menu-x: 0px;
    in property <length> menu-y: 0px;
    in property <string> file-path: "";
    in property <string> file-type: "";
    in property <bool> is-directory: false;
    callback close();
    callback action-open();
    callback action-open-with();
    callback action-show-in-finder();
    callback action-copy-path();
    callback action-convert-lsx();
    callback action-convert-lsf();
    callback action-convert-lsj();
    callback action-delete();

    // Backdrop to catch clicks outside
    if root.show-menu : Rectangle {
        x: -10000px;
        y: -10000px;
        width: 20000px;
        height: 20000px;
        background: transparent;

        TouchArea {
            width: 100%;
            height: 100%;
            clicked => { root.close(); }
        }
    }

    // The menu itself
    if root.show-menu : Rectangle {
        x: root.menu-x;
        y: root.menu-y;
        width: 200px;
        height: menu-content.preferred-height + 12px;
        background: #ffffff;
        border-radius: 8px;
        border-width: 1px;
        border-color: #d0d0d0;
        drop-shadow-blur: 12px;
        drop-shadow-color: #00000033;
        drop-shadow-offset-y: 4px;

        menu-content := VerticalLayout {
            padding: 6px;
            spacing: 2px;

            ContextMenuItem {
                icon: "üìÇ";
                label: root.is-directory ? "Open Folder" : "Open";
                clicked => { root.action-open(); root.close(); }
            }

            ContextMenuItem { is-separator: true; }

            ContextMenuItem {
                icon: "üìç";
                label: "Show in Finder";
                clicked => { root.action-show-in-finder(); root.close(); }
            }

            ContextMenuItem {
                icon: "üìã";
                label: "Copy Path";
                clicked => { root.action-copy-path(); root.close(); }
            }

            // Conversion options for Larian files
            if !root.is-directory && (root.file-type == "LSF" || root.file-type == "LSX" || root.file-type == "LSJ") : ContextMenuItem {
                is-separator: true;
            }

            if !root.is-directory && root.file-type == "LSF" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSX";
                clicked => { root.action-convert-lsx(); root.close(); }
            }

            if !root.is-directory && root.file-type == "LSF" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSJ";
                clicked => { root.action-convert-lsj(); root.close(); }
            }

            if !root.is-directory && root.file-type == "LSX" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSF";
                clicked => { root.action-convert-lsf(); root.close(); }
            }

            if !root.is-directory && root.file-type == "LSX" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSJ";
                clicked => { root.action-convert-lsj(); root.close(); }
            }

            if !root.is-directory && root.file-type == "LSJ" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSX";
                clicked => { root.action-convert-lsx(); root.close(); }
            }

            if !root.is-directory && root.file-type == "LSJ" : ContextMenuItem {
                icon: "üîÑ";
                label: "Convert to LSF";
                clicked => { root.action-convert-lsf(); root.close(); }
            }

            ContextMenuItem { is-separator: true; }

            ContextMenuItem {
                icon: "üóëÔ∏è";
                label: "Delete";
                clicked => { root.action-delete(); root.close(); }
            }
        }
    }
}

// ============================================================================
// Asset Browser Tab
// ============================================================================
export component AssetBrowserTab inherits VerticalBox {
    // Path and navigation
    in-out property <string> current-path: "";

    // File list
    in property <[FileEntry]> files: [];
    in-out property <int> selected-index: -1;

    // Filtering
    in-out property <string> search-text: "";
    in-out property <int> type-filter-index: 0;
    in-out property <bool> filter-pak: false;
    in-out property <bool> filter-larian: false;
    in-out property <bool> filter-images: false;
    in-out property <bool> filter-models: false;
    in-out property <bool> filter-scripts: false;
    in-out property <bool> filter-audio: false;
    in-out property <bool> filter-effects: false;

    // Statistics
    in-out property <int> file-count: 0;
    in-out property <int> folder-count: 0;
    in-out property <int> visible-count: 0;
    in-out property <string> total-size: "0 B";

    // Preview
    in-out property <string> preview-content: "";
    in-out property <string> preview-file-name: "";
    in-out property <string> preview-file-info: "";

    // Context menu state
    in-out property <bool> context-menu-visible: false;
    in-out property <length> context-menu-x: 0px;
    in-out property <length> context-menu-y: 0px;
    in-out property <string> context-menu-file-path: "";
    in-out property <string> context-menu-file-type: "";
    in-out property <bool> context-menu-is-dir: false;

    // Callbacks
    callback open-folder();
    callback go-up();
    callback go-to-path(string);
    callback refresh();
    callback clear-cache();
    callback file-selected(int);
    callback file-double-clicked(int);
    callback search-changed(string);
    callback filter-changed(int);
    callback toggle-filter(string);
    callback copy-path(string);
    callback show-in-finder(string);
    callback open-in-editor(string);
    callback quick-convert(string, string);  // (file-path, conversion-type)
    callback context-menu-action(string, string);  // (action, file-path)

    padding: 0px;
    spacing: 0px;

    // Header
    Rectangle {
        background: white;
        height: 56px;

        HorizontalBox {
            padding: 14px;
            padding-left: 20px;
            padding-right: 20px;

            Text {
                text: "Asset Browser";
                font-size: 22px;
                font-weight: 700;
                color: #1d1d1f;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Text {
                text: "Browse and preview game assets";
                font-size: 13px;
                color: #888888;
                vertical-alignment: center;
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Navigation bar
    Rectangle {
        background: white;
        height: 50px;

        HorizontalBox {
            padding: 10px;
            padding-left: 16px;
            padding-right: 16px;
            spacing: 8px;

            Button {
                text: "‚¨Ü Up";
                enabled: root.current-path != "";
                clicked => { root.go-up(); }
            }

            LineEdit {
                horizontal-stretch: 1;
                text <=> root.current-path;
                placeholder-text: "Enter path or click Browse to open a folder...";
                accepted => {
                    root.go-to-path(root.current-path);
                }
            }

            Button {
                text: "üìÇ Browse";
                clicked => { root.open-folder(); }
                primary: root.current-path == "";
            }

            Button {
                text: "üîÑ Refresh";
                enabled: root.current-path != "";
                clicked => { root.refresh(); }
            }

            Button {
                text: "üóë Clear Cache";
                clicked => { root.clear-cache(); }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Filter bar
    Rectangle {
        background: white;
        height: 90px;

        VerticalBox {
            padding: 8px;
            padding-left: 16px;
            padding-right: 16px;
            padding-top: 3px;
            spacing: 6px;

            // Search and type filter row
            HorizontalBox {
                spacing: 10px;

                Text {
                    text: "üîç";
                    font-size: 16px;
                    vertical-alignment: center;
                }

                LineEdit {
                    placeholder-text: "Search files...";
                    text <=> root.search-text;
                    horizontal-stretch: 1;
                    edited => { root.search-changed(root.search-text); }
                }

                Text {
                    text: "Type:";
                    font-size: 13px;
                    font-weight: 600;
                    color: #666666;
                    vertical-alignment: center;
                }

                ComboBox {
                    model: ["All Files", "PAK Files", "LSF Files", "LSX Files", "LSJ Files", "DDS Images", "Models (.gr2)", "Audio", "Localization"];
                    current-index <=> root.type-filter-index;
                    width: 150px;
                    selected => { root.filter-changed(root.type-filter-index); }
                }

                Button {
                    text: "Clear";
                    clicked => {
                        root.search-text = "";
                        root.type-filter-index = 0;
                        root.filter-pak = false;
                        root.filter-larian = false;
                        root.filter-images = false;
                        root.filter-models = false;
                        root.filter-scripts = false;
                        root.filter-audio = false;
                        root.filter-effects = false;
                        root.search-changed("");
                    }
                }
            }

            // Quick filter buttons row
            HorizontalBox {
                spacing: 6px;

                Text {
                    text: "Quick Filter:";
                    font-size: 11px;
                    font-weight: 600;
                    color: #666666;
                    vertical-alignment: center;
                }

                QuickFilterButton {
                    label: "üì¶ PAK";
                    active: root.filter-pak;
                    clicked => {
                        root.filter-pak = !root.filter-pak;
                        root.toggle-filter("pak");
                    }
                }

                QuickFilterButton {
                    label: "üìÑ Binary Files";
                    active: root.filter-larian;
                    clicked => {
                        root.filter-larian = !root.filter-larian;
                        root.toggle-filter("larian");
                    }
                }

                QuickFilterButton {
                    label: "üñºÔ∏è Images";
                    active: root.filter-images;
                    clicked => {
                        root.filter-images = !root.filter-images;
                        root.toggle-filter("images");
                    }
                }

                QuickFilterButton {
                    label: "üñåÔ∏è Models";
                    active: root.filter-models;
                    clicked => {
                        root.filter-models = !root.filter-models;
                        root.toggle-filter("models");
                    }
                }

                QuickFilterButton {
                    label: "üìú Scripts";
                    active: root.filter-scripts;
                    clicked => {
                        root.filter-scripts = !root.filter-scripts;
                        root.toggle-filter("scripts");
                    }
                }

                QuickFilterButton {
                    label: "üîä Audio";
                    active: root.filter-audio;
                    clicked => {
                        root.filter-audio = !root.filter-audio;
                        root.toggle-filter("audio");
                    }
                }

                QuickFilterButton {
                    label: "‚ú® Effects";
                    active: root.filter-effects;
                    clicked => {
                        root.filter-effects = !root.filter-effects;
                        root.toggle-filter("effects");
                    }
                }

                Rectangle { horizontal-stretch: 1; }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Main content area
    HorizontalLayout {
        vertical-stretch: 1;

        // File list with header
        VerticalLayout {
            horizontal-stretch: 3;
            min-width: 500px;

            // Column headers
            Rectangle {
                background: #f5f5f5;
                height: 34px;

                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 12px;

                    // Icon spacer
                    Rectangle { width: 26px; }

                    // Name header with sort indicator
                    HorizontalBox {
                        horizontal-stretch: 1;
                        spacing: 4px;

                        Text {
                            text: "NAME";
                            font-size: 11px;
                            font-weight: 700;
                            color: #555555;
                            letter-spacing: 0.5px;
                            vertical-alignment: center;
                        }

                        Text {
                            text: "‚ñ≤";
                            font-size: 9px;
                            color: #888888;
                            vertical-alignment: center;
                        }
                    }

                    // Type header
                    Text {
                        text: "TYPE";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 60px;
                        horizontal-alignment: center;
                    }

                    // Size header
                    Text {
                        text: "SIZE";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 80px;
                        horizontal-alignment: right;
                    }

                    // Modified header
                    Text {
                        text: "MODIFIED";
                        font-size: 11px;
                        font-weight: 700;
                        color: #555555;
                        letter-spacing: 0.5px;
                        vertical-alignment: center;
                        width: 120px;
                    }
                }
            }

            Rectangle { height: 1px; background: #e0e0e0; }

            // File list with keyboard navigation
            Rectangle {
                background: #ffffff;
                vertical-stretch: 1;

                file-focus := FocusScope {
                    width: 100%;
                    height: 100%;

                    key-pressed(event) => {
                        if (event.text == Key.UpArrow) {
                            if root.selected-index > 0 {
                                root.selected-index = root.selected-index - 1;
                                root.file-selected(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.DownArrow) {
                            if root.selected-index < root.files.length - 1 {
                                root.selected-index = root.selected-index + 1;
                                root.file-selected(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.Return) {
                            if root.selected-index >= 0 && root.selected-index < root.files.length {
                                root.file-double-clicked(root.selected-index);
                            }
                            return accept;
                        } else if (event.text == Key.Escape) {
                            // Close context menu first, then deselect
                            if root.context-menu-visible {
                                root.context-menu-visible = false;
                            } else {
                                root.selected-index = -1;
                            }
                            return accept;
                        }
                        return reject;
                    }
                }

                if root.files.length == 0 : VerticalLayout {
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: root.current-path == "" ? "üìÅ" : "üìÇ";
                        font-size: 48px;
                        horizontal-alignment: center;
                        color: #cccccc;
                    }

                    Text {
                        text: root.current-path == "" ? "Select a folder to browse" : "No files in this directory";
                        color: #999999;
                        font-size: 14px;
                        horizontal-alignment: center;
                    }

                    if root.current-path == "" : Text {
                        text: "Click \"Browse\" to open a folder";
                        color: #bbbbbb;
                        font-size: 12px;
                        horizontal-alignment: center;
                    }
                }

                if root.files.length > 0 : ScrollView {
                    VerticalLayout {
                        alignment: start;

                        for file[idx] in root.files : FileRow {
                            entry: file;
                            selected: idx == root.selected-index;
                            alternate: mod(idx, 2) == 1;
                            clicked => {
                                root.selected-index = idx;
                                root.file-selected(idx);
                                file-focus.focus();
                                // Close context menu on regular click
                                root.context-menu-visible = false;
                            }
                            double-clicked => {
                                root.file-double-clicked(idx);
                            }
                            right-clicked(x, y) => {
                                // Select the file first
                                root.selected-index = idx;
                                root.file-selected(idx);
                                // Show context menu at click position
                                root.context-menu-file-path = file.full-path;
                                root.context-menu-file-type = file.file-type;
                                root.context-menu-is-dir = file.is-dir;
                                root.context-menu-x = self.x + x;
                                root.context-menu-y = self.y + y;
                                root.context-menu-visible = true;
                            }
                        }
                    }
                }

                // Context menu overlay
                ContextMenu {
                    show-menu: root.context-menu-visible;
                    menu-x: root.context-menu-x;
                    menu-y: root.context-menu-y;
                    file-path: root.context-menu-file-path;
                    file-type: root.context-menu-file-type;
                    is-directory: root.context-menu-is-dir;
                    close => {
                        root.context-menu-visible = false;
                    }
                    action-open => {
                        root.file-double-clicked(root.selected-index);
                    }
                    action-open-with => {
                        root.open-in-editor(root.context-menu-file-path);
                    }
                    action-show-in-finder => {
                        root.show-in-finder(root.context-menu-file-path);
                    }
                    action-copy-path => {
                        root.copy-path(root.context-menu-file-path);
                    }
                    action-convert-lsx => {
                        if root.context-menu-file-type == "LSF" {
                            root.quick-convert(root.context-menu-file-path, "lsf-to-lsx");
                        } else if root.context-menu-file-type == "LSJ" {
                            root.quick-convert(root.context-menu-file-path, "lsj-to-lsx");
                        }
                    }
                    action-convert-lsf => {
                        if root.context-menu-file-type == "LSX" {
                            root.quick-convert(root.context-menu-file-path, "lsx-to-lsf");
                        } else if root.context-menu-file-type == "LSJ" {
                            root.quick-convert(root.context-menu-file-path, "lsj-to-lsf");
                        }
                    }
                    action-convert-lsj => {
                        if root.context-menu-file-type == "LSF" {
                            root.quick-convert(root.context-menu-file-path, "lsf-to-lsj");
                        } else if root.context-menu-file-type == "LSX" {
                            root.quick-convert(root.context-menu-file-path, "lsx-to-lsj");
                        }
                    }
                    action-delete => {
                        root.context-menu-action("delete", root.context-menu-file-path);
                    }
                }
            }
        }

        Rectangle { width: 1px; background: #e0e0e0; }

        // Preview pane
        VerticalLayout {
            horizontal-stretch: 1;
            min-width: 320px;

            // Preview header
            Rectangle {
                background: #f5f5f5;
                height: 44px;

                HorizontalLayout {
                    padding: 10px;
                    padding-left: 14px;
                    padding-right: 14px;
                    spacing: 10px;

                    Text {
                        text: "Preview";
                        font-size: 14px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }

                    Rectangle { horizontal-stretch: 1; }

                    if root.preview-file-name != "" : HorizontalBox {
                        spacing: 8px;

                        Button {
                            text: "üìã Copy";
                            clicked => {
                                if root.selected-index >= 0 && root.selected-index < root.files.length {
                                    root.copy-path(root.files[root.selected-index].full-path);
                                }
                            }
                        }

                        Button {
                            text: "üìÇ Show";
                            clicked => {
                                if root.selected-index >= 0 && root.selected-index < root.files.length {
                                    root.show-in-finder(root.files[root.selected-index].full-path);
                                }
                            }
                        }
                    }
                }
            }

            Rectangle { height: 1px; background: #e0e0e0; }

            // File info
            if root.preview-file-name != "" : Rectangle {
                background: #fafafa;
                height: 56px;

                HorizontalLayout {
                    padding: 10px;
                    padding-left: 14px;
                    padding-right: 14px;

                    VerticalBox {
                        spacing: 2px;
                        horizontal-stretch: 1;

                        Text {
                            text: root.preview-file-name;
                            font-size: 13px;
                            font-weight: 600;
                            overflow: elide;
                        }

                        Text {
                            text: root.preview-file-info;
                            font-size: 11px;
                            color: #666666;
                        }
                    }
                }
            }

            // Quick Convert bar - shown for convertible files
            if root.selected-index >= 0 && root.selected-index < root.files.length : Rectangle {
                property <string> selected-type: root.files[root.selected-index].file-type;
                property <string> selected-path: root.files[root.selected-index].full-path;
                property <bool> is-lsf: selected-type == "LSF";
                property <bool> is-lsx: selected-type == "LSX";
                property <bool> is-lsj: selected-type == "LSJ";
                property <bool> show-convert: is-lsf || is-lsx || is-lsj;

                background: #f0f8ff;
                height: show-convert ? 36px : 0px;
                visible: show-convert;

                HorizontalBox {
                    padding: 6px;
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 8px;

                    Text {
                        text: "Quick Convert:";
                        font-size: 11px;
                        font-weight: 600;
                        color: #666666;
                        vertical-alignment: center;
                    }

                    // LSF -> LSX
                    if is-lsf : Button {
                        text: "‚Üí LSX";
                        clicked => { root.quick-convert(selected-path, "lsf-to-lsx"); }
                    }
                    // LSF -> LSJ
                    if is-lsf : Button {
                        text: "‚Üí LSJ";
                        clicked => { root.quick-convert(selected-path, "lsf-to-lsj"); }
                    }
                    // LSX -> LSF
                    if is-lsx : Button {
                        text: "‚Üí LSF";
                        clicked => { root.quick-convert(selected-path, "lsx-to-lsf"); }
                    }
                    // LSX -> LSJ
                    if is-lsx : Button {
                        text: "‚Üí LSJ";
                        clicked => { root.quick-convert(selected-path, "lsx-to-lsj"); }
                    }
                    // LSJ -> LSX
                    if is-lsj : Button {
                        text: "‚Üí LSX";
                        clicked => { root.quick-convert(selected-path, "lsj-to-lsx"); }
                    }
                    // LSJ -> LSF
                    if is-lsj : Button {
                        text: "‚Üí LSF";
                        clicked => { root.quick-convert(selected-path, "lsj-to-lsf"); }
                    }

                    Rectangle { horizontal-stretch: 1; }
                }
            }

            if root.preview-file-name != "" : Rectangle { height: 1px; background: #e0e0e0; }

            // Preview content
            Rectangle {
                background: white;
                vertical-stretch: 1;

                if root.preview-content == "" && root.preview-file-name == "" : VerticalLayout {
                    alignment: center;
                    spacing: 8px;

                    Text {
                        text: "üìÑ";
                        font-size: 48px;
                        horizontal-alignment: center;
                        color: #cccccc;
                    }

                    Text {
                        text: "Select a file to preview";
                        color: #999999;
                        font-size: 14px;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Click on a file in the list to see its contents";
                        color: #bbbbbb;
                        font-size: 12px;
                        horizontal-alignment: center;
                    }
                }

                if root.preview-content != "" : ScrollView {
                    VerticalBox {
                        padding: 14px;

                        Text {
                            text: root.preview-content;
                            font-size: 12px;
                            wrap: word-wrap;
                            font-family: "monospace";
                        }
                    }
                }
            }
        }
    }

    Rectangle { height: 1px; background: #e0e0e0; }

    // Status bar
    Rectangle {
        background: #f8f8f8;
        height: 32px;

        HorizontalBox {
            padding-left: 20px;
            padding-right: 20px;
            spacing: 8px;

            // Items shown count
            Text {
                text: root.visible-count + " items shown";
                font-size: 12px;
                color: #555555;
                vertical-alignment: center;
            }

            if root.visible-count != root.file-count + root.folder-count : Text {
                text: "(" + root.file-count + " files, " + root.folder-count + " folders total)";
                font-size: 12px;
                color: #888888;
                vertical-alignment: center;
            }

            // Separator
            Text {
                text: "|";
                font-size: 12px;
                color: #cccccc;
                vertical-alignment: center;
            }

            // Total size
            Text {
                text: "Total: " + root.total-size;
                font-size: 12px;
                color: #555555;
                font-weight: 500;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            // Filter indicator
            if root.filter-pak || root.filter-larian || root.filter-images || root.filter-models || root.filter-scripts || root.filter-audio || root.filter-effects : Rectangle {
                background: #e7f3ff;
                border-radius: 10px;
                height: 22px;
                width: filter-text.preferred-width + 16px;

                filter-text := Text {
                    text: "‚óè Filters active";
                    font-size: 11px;
                    color: #007AFF;
                    font-weight: 600;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
            }
        }
    }
}

// ============================================================================
// Universal Editor Tab
// ============================================================================
export component UniversalEditorTab inherits VerticalBox {
    in-out property <string> file-path: "";
    in-out property <string> content: "";
    in-out property <bool> modified: false;
    in-out property <bool> converting: false;
    in-out property <string> file-format: "";
    in-out property <string> status-message: "";

    callback open();
    callback save();
    callback save-as();
    callback convert(string);

    padding: 0px;
    spacing: 0px;

    // Toolbar
    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        height: 50px;

        Button {
            text: "Open";
            clicked => { root.open(); }
        }
        Button {
            text: "Save";
            clicked => { root.save(); }
            enabled: root.modified;
        }
        Button {
            text: "Save As...";
            clicked => { root.save-as(); }
            enabled: root.file-path != "";
        }

        Rectangle { horizontal-stretch: 1; }

        if root.modified : Rectangle {
            background: #fff3cd;
            border-radius: 4px;
            width: 80px;

            Text {
                text: "Modified";
                font-size: 12px;
                color: #856404;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        if root.file-format != "" : Rectangle {
            background: #e7f3ff;
            border-radius: 4px;
            width: 60px;

            Text {
                text: root.file-format;
                font-size: 12px;
                color: #0056b3;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Conversion toolbar
    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        height: 50px;

        Text {
            text: "Convert:";
            vertical-alignment: center;
            font-weight: 600;
        }

        Button {
            text: "LSF ‚Üí LSX";
            clicked => { root.convert("lsf-to-lsx"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSX ‚Üí LSF";
            clicked => { root.convert("lsx-to-lsf"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSX ‚Üí LSJ";
            clicked => { root.convert("lsx-to-lsj"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSJ ‚Üí LSX";
            clicked => { root.convert("lsj-to-lsx"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSF ‚Üí LSJ";
            clicked => { root.convert("lsf-to-lsj"); }
            enabled: !root.converting;
        }
        Button {
            text: "LSJ ‚Üí LSF";
            clicked => { root.convert("lsj-to-lsf"); }
            enabled: !root.converting;
        }

        if root.converting : Text {
            text: "Converting...";
            color: #666666;
            vertical-alignment: center;
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Editor content
    Rectangle {
        background: white;
        vertical-stretch: 1;

        TextEdit {
            text <=> root.content;
            font-size: 13px;
            edited => { root.modified = true; }
        }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Status bar
    HorizontalBox {
        padding: 8px;
        padding-left: 12px;
        height: 32px;

        Text {
            text: root.file-path == "" ? "No file loaded" : root.file-path;
            font-size: 12px;
            color: #666666;
            vertical-alignment: center;
            overflow: elide;
            horizontal-stretch: 1;
        }

        if root.status-message != "" : Text {
            text: root.status-message;
            font-size: 12px;
            color: #28a745;
            vertical-alignment: center;
        }
    }
}

// ============================================================================
// PAK Operations Tab
// ============================================================================
export component PakOperationsTab inherits ScrollView {
    in-out property <string> extract-source: "";
    in-out property <string> extract-dest: "";
    in-out property <float> extract-progress: 0.0;
    in-out property <bool> is-extracting: false;
    in-out property <string> extract-status: "";

    in-out property <string> create-source: "";
    in-out property <string> create-dest: "";
    in-out property <float> create-progress: 0.0;
    in-out property <bool> is-creating: false;
    in-out property <string> create-status: "";

    in-out property <string> list-source: "";
    in-out property <bool> is-listing: false;
    in-out property <[string]> list-contents: [];

    callback browse-extract-source();
    callback browse-extract-dest();
    callback extract();

    callback browse-create-source();
    callback browse-create-dest();
    callback create();

    callback browse-list-source();
    callback list();

    VerticalBox {
        padding: 20px;
        spacing: 30px;

        // ===== Extract Section =====
        VerticalBox {
            spacing: 12px;

            Text {
                text: "Extract PAK Archive";
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                text: "Extract files from a PAK archive to a directory";
                font-size: 14px;
                color: #666666;
            }

            HorizontalBox {
                spacing: 10px;
                height: 36px;

                Text {
                    text: "Source PAK:";
                    width: 120px;
                    vertical-alignment: center;
                    font-weight: 500;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.extract-source == "" ? "No file selected" : root.extract-source;
                        x: 10px;
                        vertical-alignment: center;
                        color: root.extract-source == "" ? #999999 : black;
                        overflow: elide;
                    }
                }

                Button {
                    text: "Browse...";
                    clicked => { root.browse-extract-source(); }
                }
            }

            HorizontalBox {
                spacing: 10px;
                height: 36px;

                Text {
                    text: "Destination:";
                    width: 120px;
                    vertical-alignment: center;
                    font-weight: 500;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.extract-dest == "" ? "No directory selected" : root.extract-dest;
                        x: 10px;
                        vertical-alignment: center;
                        color: root.extract-dest == "" ? #999999 : black;
                        overflow: elide;
                    }
                }

                Button {
                    text: "Browse...";
                    clicked => { root.browse-extract-dest(); }
                }
            }

            if root.is-extracting : VerticalBox {
                spacing: 8px;

                HorizontalBox {
                    Text {
                        text: root.extract-status;
                        font-size: 13px;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Text {
                        text: Math.round(root.extract-progress) + "%";
                        font-size: 13px;
                        font-weight: 500;
                    }
                }

                ProgressIndicator {
                    progress: root.extract-progress / 100.0;
                    height: 8px;
                }
            }

            if !root.is-extracting : Button {
                text: "Extract PAK";
                enabled: root.extract-source != "" && root.extract-dest != "";
                clicked => { root.extract(); }
                primary: root.extract-source != "" && root.extract-dest != "";
            }
        }

        Rectangle { height: 2px; background: #eeeeee; }

        // ===== Create Section =====
        VerticalBox {
            spacing: 12px;

            Text {
                text: "Create PAK Archive";
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                text: "Create a PAK archive from a directory of mod files";
                font-size: 14px;
                color: #666666;
            }

            HorizontalBox {
                spacing: 10px;
                height: 36px;

                Text {
                    text: "Source Dir:";
                    width: 120px;
                    vertical-alignment: center;
                    font-weight: 500;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.create-source == "" ? "No directory selected" : root.create-source;
                        x: 10px;
                        vertical-alignment: center;
                        color: root.create-source == "" ? #999999 : black;
                        overflow: elide;
                    }
                }

                Button {
                    text: "Browse...";
                    clicked => { root.browse-create-source(); }
                }
            }

            HorizontalBox {
                spacing: 10px;
                height: 36px;

                Text {
                    text: "Destination:";
                    width: 120px;
                    vertical-alignment: center;
                    font-weight: 500;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.create-dest == "" ? "No file selected" : root.create-dest;
                        x: 10px;
                        vertical-alignment: center;
                        color: root.create-dest == "" ? #999999 : black;
                        overflow: elide;
                    }
                }

                Button {
                    text: "Browse...";
                    clicked => { root.browse-create-dest(); }
                }
            }

            if root.is-creating : VerticalBox {
                spacing: 8px;

                HorizontalBox {
                    Text {
                        text: root.create-status;
                        font-size: 13px;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Text {
                        text: Math.round(root.create-progress) + "%";
                        font-size: 13px;
                        font-weight: 500;
                    }
                }

                ProgressIndicator {
                    progress: root.create-progress / 100.0;
                    height: 8px;
                }
            }

            if !root.is-creating : Button {
                text: "Create PAK";
                enabled: root.create-source != "" && root.create-dest != "";
                clicked => { root.create(); }
                primary: root.create-source != "" && root.create-dest != "";
            }
        }

        Rectangle { height: 2px; background: #eeeeee; }

        // ===== List Section =====
        VerticalBox {
            spacing: 12px;

            Text {
                text: "List PAK Contents";
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                text: "View the contents of a PAK archive";
                font-size: 14px;
                color: #666666;
            }

            HorizontalBox {
                spacing: 10px;
                height: 36px;

                Text {
                    text: "PAK File:";
                    width: 120px;
                    vertical-alignment: center;
                    font-weight: 500;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.list-source == "" ? "No file selected" : root.list-source;
                        x: 10px;
                        vertical-alignment: center;
                        color: root.list-source == "" ? #999999 : black;
                        overflow: elide;
                    }
                }

                Button {
                    text: "Browse...";
                    clicked => { root.browse-list-source(); }
                }
            }

            HorizontalBox {
                spacing: 10px;

                if root.is-listing : Text {
                    text: "Loading contents...";
                    font-size: 14px;
                    color: #666666;
                }

                if !root.is-listing : Button {
                    text: "List Contents";
                    enabled: root.list-source != "";
                    clicked => { root.list(); }
                    primary: root.list-source != "";
                }

                if root.list-contents.length > 0 : Text {
                    text: root.list-contents.length + " files";
                    font-size: 14px;
                    color: #666666;
                    vertical-alignment: center;
                }
            }

            // Contents list
            if root.list-contents.length > 0 : Rectangle {
                background: #f8f8f8;
                border-radius: 4px;
                height: 300px;

                ScrollView {
                    VerticalBox {
                        padding: 10px;
                        spacing: 2px;

                        for file in root.list-contents : Text {
                            text: file;
                            font-size: 12px;
                            font-family: "monospace";
                        }
                    }
                }
            }
        }
    }
}

// ============================================================================
// Index Search Tab
// ============================================================================
export component IndexSearchTab inherits VerticalBox {
    in-out property <string> query: "";
    in-out property <bool> is-searching: false;
    in-out property <[string]> results: [];
    in-out property <string> status: "";

    // Index management
    in-out property <int> indexed-files: 0;
    in-out property <int> indexed-paks: 0;
    in-out property <bool> is-indexing: false;
    in-out property <float> index-progress: 0.0;

    callback execute();
    callback index-directory();
    callback index-pak();
    callback clear-index();

    padding: 20px;
    spacing: 15px;

    Text {
        text: "Index Search";
        font-size: 24px;
        font-weight: 700;
    }

    Text {
        text: "Search indexed files from PAK archives and directories";
        font-size: 14px;
        color: #666666;
    }

    // Search bar
    HorizontalBox {
        spacing: 10px;
        height: 40px;

        LineEdit {
            placeholder-text: "Enter search query (* and ? wildcards supported)...";
            text <=> root.query;
            horizontal-stretch: 1;
            accepted => { root.execute(); }
        }

        Button {
            text: root.is-searching ? "Searching..." : "Search";
            clicked => { root.execute(); }
            enabled: !root.is-searching && root.query != "";
            primary: true;
        }
    }

    // Index management section
    Rectangle {
        background: #f8f8f8;
        border-radius: 4px;
        height: 60px;

        HorizontalBox {
            padding: 12px;
            spacing: 20px;

            Text {
                text: "Index: " + root.indexed-files + " files from " + root.indexed-paks + " PAKs";
                vertical-alignment: center;
                font-size: 13px;
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Index PAK";
                clicked => { root.index-pak(); }
                enabled: !root.is-indexing;
            }

            Button {
                text: "Index Directory";
                clicked => { root.index-directory(); }
                enabled: !root.is-indexing;
            }

            Button {
                text: "Clear Index";
                clicked => { root.clear-index(); }
                enabled: !root.is-indexing && root.indexed-files > 0;
            }
        }
    }

    if root.is-indexing : HorizontalBox {
        spacing: 10px;

        Text { text: "Indexing..."; font-size: 13px; }
        ProgressIndicator {
            progress: root.index-progress / 100.0;
            horizontal-stretch: 1;
        }
        Text { text: Math.round(root.index-progress) + "%"; font-size: 13px; }
    }

    Rectangle { height: 1px; background: #dddddd; }

    // Status
    if root.status != "" : Text {
        text: root.status;
        font-size: 13px;
        color: #666666;
    }

    // Results
    Rectangle {
        background: #f8f8f8;
        border-radius: 4px;
        vertical-stretch: 1;

        if root.results.length == 0 : Text {
            text: root.is-searching ? "Searching..." : "No results. Enter a search query above.";
            font-size: 14px;
            color: #999999;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        if root.results.length > 0 : ScrollView {
            VerticalBox {
                padding: 10px;
                spacing: 4px;

                for result in root.results : Rectangle {
                    background: white;
                    border-radius: 4px;
                    height: 32px;

                    HorizontalBox {
                        padding-left: 12px;
                        padding-right: 12px;

                        Text {
                            text: result;
                            font-size: 13px;
                            font-family: "monospace";
                            vertical-alignment: center;
                            overflow: elide;
                        }
                    }
                }
            }
        }
    }
}

// ============================================================================
// UUID Generator Tab
// ============================================================================
export component UuidGeneratorTab inherits ScrollView {
    in-out property <string> last-uuid: "";
    in-out property <string> last-handle: "";
    in-out property <[string]> uuid-history: [];
    in-out property <[string]> handle-history: [];
    in-out property <string> copy-status: "";

    callback generate-uuid();
    callback generate-handle();
    callback copy(string);
    callback export-history();
    callback clear-history();

    VerticalBox {
        padding: 20px;
        spacing: 25px;

        // ===== UUID Section =====
        VerticalBox {
            spacing: 12px;

            Text {
                text: "UUID Generator";
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                text: "Generate unique identifiers for BG3 mods (UUID v4 format)";
                font-size: 14px;
                color: #666666;
            }

            HorizontalBox {
                spacing: 10px;
                height: 40px;

                Button {
                    text: "Generate UUID";
                    clicked => { root.generate-uuid(); }
                    primary: true;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.last-uuid == "" ? "Click 'Generate UUID' to create" : root.last-uuid;
                        x: 12px;
                        font-size: 14px;
                        font-family: "monospace";
                        vertical-alignment: center;
                        color: root.last-uuid == "" ? #999999 : black;
                    }
                }

                if root.last-uuid != "" : Button {
                    text: "Copy";
                    clicked => { root.copy(root.last-uuid); }
                }
            }
        }

        Rectangle { height: 2px; background: #eeeeee; }

        // ===== Handle Section =====
        VerticalBox {
            spacing: 12px;

            Text {
                text: "TranslatedString Handle Generator";
                font-size: 24px;
                font-weight: 700;
            }

            Text {
                text: "Generate numeric handles for translated strings in localization files";
                font-size: 14px;
                color: #666666;
            }

            HorizontalBox {
                spacing: 10px;
                height: 40px;

                Button {
                    text: "Generate Handle";
                    clicked => { root.generate-handle(); }
                    primary: true;
                }

                Rectangle {
                    background: #f8f8f8;
                    border-radius: 4px;
                    horizontal-stretch: 1;

                    Text {
                        text: root.last-handle == "" ? "Click 'Generate Handle' to create" : "h" + root.last-handle;
                        x: 12px;
                        font-size: 14px;
                        font-family: "monospace";
                        vertical-alignment: center;
                        color: root.last-handle == "" ? #999999 : black;
                    }
                }

                if root.last-handle != "" : Button {
                    text: "Copy";
                    clicked => { root.copy(root.last-handle); }
                }
            }
        }

        Rectangle { height: 2px; background: #eeeeee; }

        // ===== History Section =====
        VerticalBox {
            spacing: 12px;

            HorizontalBox {
                Text {
                    text: "Generation History";
                    font-size: 20px;
                    font-weight: 700;
                }

                Rectangle { horizontal-stretch: 1; }

                if root.copy-status != "" : Text {
                    text: root.copy-status;
                    font-size: 12px;
                    color: #28a745;
                    vertical-alignment: center;
                }

                Button {
                    text: "Export JSON";
                    clicked => { root.export-history(); }
                    enabled: root.uuid-history.length > 0 || root.handle-history.length > 0;
                }

                Button {
                    text: "Clear";
                    clicked => { root.clear-history(); }
                    enabled: root.uuid-history.length > 0 || root.handle-history.length > 0;
                }
            }

            HorizontalBox {
                spacing: 15px;
                vertical-stretch: 1;

                // UUID History
                VerticalBox {
                    horizontal-stretch: 1;

                    Text {
                        text: "UUIDs (" + root.uuid-history.length + ")";
                        font-size: 14px;
                        font-weight: 600;
                    }

                    Rectangle {
                        background: #f8f8f8;
                        border-radius: 4px;
                        vertical-stretch: 1;

                        ScrollView {
                            VerticalBox {
                                padding: 8px;
                                spacing: 4px;

                                for uuid in root.uuid-history : HorizontalBox {
                                    height: 28px;

                                    Text {
                                        text: uuid;
                                        font-size: 12px;
                                        font-family: "monospace";
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    TouchArea {
                                        width: 40px;
                                        clicked => { root.copy(uuid); }

                                        Text {
                                            text: "Copy";
                                            font-size: 11px;
                                            color: #0078d4;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // Handle History
                VerticalBox {
                    horizontal-stretch: 1;

                    Text {
                        text: "Handles (" + root.handle-history.length + ")";
                        font-size: 14px;
                        font-weight: 600;
                    }

                    Rectangle {
                        background: #f8f8f8;
                        border-radius: 4px;
                        vertical-stretch: 1;

                        ScrollView {
                            VerticalBox {
                                padding: 8px;
                                spacing: 4px;

                                for handle in root.handle-history : HorizontalBox {
                                    height: 28px;

                                    Text {
                                        text: "h" + handle;
                                        font-size: 12px;
                                        font-family: "monospace";
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    TouchArea {
                                        width: 40px;
                                        clicked => { root.copy(handle); }

                                        Text {
                                            text: "Copy";
                                            font-size: 11px;
                                            color: #0078d4;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

// ============================================================================
// About Dialog
// ============================================================================
component AboutDialog inherits Rectangle {
    in-out property <bool> dialog-visible: false;
    in-out property <string> version: "0.1.0";

    callback close();

    if root.dialog-visible : Rectangle {
        background: #00000088;

        TouchArea {
            clicked => { root.close(); }
        }

        Rectangle {
            width: 400px;
            height: 280px;
            background: white;
            border-radius: 12px;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000044;

            TouchArea {}  // Prevent clicks from passing through

            VerticalBox {
                padding: 24px;
                spacing: 16px;

                Text {
                    text: "MacPak";
                    font-size: 28px;
                    font-weight: 700;
                    horizontal-alignment: center;
                }

                Text {
                    text: "BG3 Modding Toolkit for macOS";
                    font-size: 14px;
                    color: #666666;
                    horizontal-alignment: center;
                }

                Text {
                    text: "Version " + root.version;
                    font-size: 13px;
                    color: #999999;
                    horizontal-alignment: center;
                }

                Rectangle { vertical-stretch: 1; }

                Text {
                    text: "Native PAK, LSX, LSF, and LSJ support";
                    font-size: 12px;
                    color: #666666;
                    horizontal-alignment: center;
                }

                Text {
                    text: "No Wine or external tools required";
                    font-size: 12px;
                    color: #666666;
                    horizontal-alignment: center;
                }

                Rectangle { vertical-stretch: 1; }

                Button {
                    text: "Close";
                    clicked => { root.close(); }
                    horizontal-stretch: 0;
                }
            }
        }
    }
}

// ============================================================================
// Main Application Window
// ============================================================================
export component MacPakApp inherits Window {
    title: "MacPak - BG3 Modding Toolkit";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;

    // Application info
    in-out property <string> app-version: "0.1.0";

    // Tab state
    in-out property <int> current-tab: 0;

    // Error dialog
    in-out property <bool> show-error: false;
    in-out property <string> error-message: "";

    // About dialog
    in-out property <bool> show-about: false;

    // Asset Browser state
    in-out property <string> browser-path: "";
    in-out property <[FileEntry]> browser-files: [];
    in-out property <int> browser-selected: -1;
    in-out property <string> browser-search-text: "";
    in-out property <int> browser-type-filter: 0;
    in-out property <bool> browser-filter-pak: false;
    in-out property <bool> browser-filter-larian: false;
    in-out property <bool> browser-filter-images: false;
    in-out property <bool> browser-filter-models: false;
    in-out property <bool> browser-filter-scripts: false;
    in-out property <bool> browser-filter-audio: false;
    in-out property <bool> browser-filter-effects: false;
    in-out property <int> browser-file-count: 0;
    in-out property <int> browser-folder-count: 0;
    in-out property <int> browser-visible-count: 0;
    in-out property <string> browser-total-size: "0 B";
    in-out property <string> browser-preview-content: "";
    in-out property <string> browser-preview-name: "";
    in-out property <string> browser-preview-info: "";
    in-out property <bool> browser-context-menu-visible: false;
    in-out property <length> browser-context-menu-x: 0px;
    in-out property <length> browser-context-menu-y: 0px;
    in-out property <string> browser-context-menu-file-path: "";
    in-out property <string> browser-context-menu-file-type: "";
    in-out property <bool> browser-context-menu-is-dir: false;

    // Editor state
    in-out property <string> editor-file-path: "";
    in-out property <string> editor-content: "";
    in-out property <bool> editor-modified: false;
    in-out property <bool> editor-converting: false;
    in-out property <string> editor-format: "";
    in-out property <string> editor-status: "";

    // PAK Operations state
    in-out property <string> pak-extract-source: "";
    in-out property <string> pak-extract-dest: "";
    in-out property <float> pak-extract-progress: 0.0;
    in-out property <bool> pak-is-extracting: false;
    in-out property <string> pak-extract-status: "";

    in-out property <string> pak-create-source: "";
    in-out property <string> pak-create-dest: "";
    in-out property <float> pak-create-progress: 0.0;
    in-out property <bool> pak-is-creating: false;
    in-out property <string> pak-create-status: "";

    in-out property <string> pak-list-source: "";
    in-out property <bool> pak-is-listing: false;
    in-out property <[string]> pak-list-contents: [];

    // Search state
    in-out property <string> search-query: "";
    in-out property <bool> search-is-searching: false;
    in-out property <[string]> search-results: [];
    in-out property <string> search-status: "";
    in-out property <int> search-indexed-files: 0;
    in-out property <int> search-indexed-paks: 0;
    in-out property <bool> search-is-indexing: false;
    in-out property <float> search-index-progress: 0.0;

    // UUID Generator state
    in-out property <string> last-uuid: "";
    in-out property <string> last-handle: "";
    in-out property <[string]> uuid-history: [];
    in-out property <[string]> handle-history: [];
    in-out property <string> copy-status: "";

    // Callbacks
    callback tab-changed(int);

    // Browser callbacks
    callback browser-open-folder();
    callback browser-go-up();
    callback browser-go-to-path(string);
    callback browser-refresh();
    callback browser-clear-cache();
    callback browser-file-selected(int);
    callback browser-file-double-clicked(int);
    callback browser-search-changed(string);
    callback browser-filter-changed(int);
    callback browser-toggle-filter(string);
    callback browser-copy-path(string);
    callback browser-show-in-finder(string);
    callback browser-open-in-editor(string);
    callback browser-quick-convert(string, string);
    callback browser-context-menu-action(string, string);

    // Editor callbacks
    callback editor-open();
    callback editor-save();
    callback editor-save-as();
    callback editor-convert(string);

    // PAK callbacks
    callback pak-browse-extract-source();
    callback pak-browse-extract-dest();
    callback pak-extract();
    callback pak-browse-create-source();
    callback pak-browse-create-dest();
    callback pak-create();
    callback pak-browse-list-source();
    callback pak-list();

    // Search callbacks
    callback search-execute();
    callback search-index-directory();
    callback search-index-pak();
    callback search-clear-index();

    // UUID callbacks
    callback uuid-generate();
    callback handle-generate();
    callback copy-to-clipboard(string);
    callback uuid-export-history();
    callback uuid-clear-history();

    // Menu callbacks
    callback show-settings();
    callback show-about-dialog();

    VerticalBox {
        padding: 0px;

        TabWidget {
            current-index <=> root.current-tab;

            Tab {
                title: "Asset Browser";

                AssetBrowserTab {
                    current-path <=> root.browser-path;
                    files: root.browser-files;
                    selected-index <=> root.browser-selected;
                    search-text <=> root.browser-search-text;
                    type-filter-index <=> root.browser-type-filter;
                    filter-pak <=> root.browser-filter-pak;
                    filter-larian <=> root.browser-filter-larian;
                    filter-images <=> root.browser-filter-images;
                    filter-models <=> root.browser-filter-models;
                    filter-scripts <=> root.browser-filter-scripts;
                    filter-audio <=> root.browser-filter-audio;
                    filter-effects <=> root.browser-filter-effects;
                    file-count: root.browser-file-count;
                    folder-count: root.browser-folder-count;
                    visible-count: root.browser-visible-count;
                    total-size: root.browser-total-size;
                    preview-content: root.browser-preview-content;
                    preview-file-name: root.browser-preview-name;
                    preview-file-info: root.browser-preview-info;
                    context-menu-visible <=> root.browser-context-menu-visible;
                    context-menu-x <=> root.browser-context-menu-x;
                    context-menu-y <=> root.browser-context-menu-y;
                    context-menu-file-path <=> root.browser-context-menu-file-path;
                    context-menu-file-type <=> root.browser-context-menu-file-type;
                    context-menu-is-dir <=> root.browser-context-menu-is-dir;

                    open-folder => { root.browser-open-folder(); }
                    go-up => { root.browser-go-up(); }
                    go-to-path(path) => { root.browser-go-to-path(path); }
                    refresh => { root.browser-refresh(); }
                    clear-cache => { root.browser-clear-cache(); }
                    file-selected(idx) => { root.browser-file-selected(idx); }
                    file-double-clicked(idx) => { root.browser-file-double-clicked(idx); }
                    search-changed(text) => { root.browser-search-changed(text); }
                    filter-changed(idx) => { root.browser-filter-changed(idx); }
                    toggle-filter(filter) => { root.browser-toggle-filter(filter); }
                    copy-path(path) => { root.browser-copy-path(path); }
                    show-in-finder(path) => { root.browser-show-in-finder(path); }
                    open-in-editor(path) => { root.browser-open-in-editor(path); }
                    quick-convert(path, conv) => { root.browser-quick-convert(path, conv); }
                    context-menu-action(action, path) => { root.browser-context-menu-action(action, path); }
                }
            }

            Tab {
                title: "Universal Editor";

                UniversalEditorTab {
                    file-path: root.editor-file-path;
                    content: root.editor-content;
                    modified: root.editor-modified;
                    converting: root.editor-converting;
                    file-format: root.editor-format;
                    status-message: root.editor-status;

                    open => { root.editor-open(); }
                    save => { root.editor-save(); }
                    save-as => { root.editor-save-as(); }
                    convert(format) => { root.editor-convert(format); }
                }
            }

            Tab {
                title: "PAK Operations";

                PakOperationsTab {
                    extract-source: root.pak-extract-source;
                    extract-dest: root.pak-extract-dest;
                    extract-progress: root.pak-extract-progress;
                    is-extracting: root.pak-is-extracting;
                    extract-status: root.pak-extract-status;

                    create-source: root.pak-create-source;
                    create-dest: root.pak-create-dest;
                    create-progress: root.pak-create-progress;
                    is-creating: root.pak-is-creating;
                    create-status: root.pak-create-status;

                    list-source: root.pak-list-source;
                    is-listing: root.pak-is-listing;
                    list-contents: root.pak-list-contents;

                    browse-extract-source => { root.pak-browse-extract-source(); }
                    browse-extract-dest => { root.pak-browse-extract-dest(); }
                    extract => { root.pak-extract(); }
                    browse-create-source => { root.pak-browse-create-source(); }
                    browse-create-dest => { root.pak-browse-create-dest(); }
                    create => { root.pak-create(); }
                    browse-list-source => { root.pak-browse-list-source(); }
                    list => { root.pak-list(); }
                }
            }

            Tab {
                title: "Index Search";

                IndexSearchTab {
                    query: root.search-query;
                    is-searching: root.search-is-searching;
                    results: root.search-results;
                    status: root.search-status;
                    indexed-files: root.search-indexed-files;
                    indexed-paks: root.search-indexed-paks;
                    is-indexing: root.search-is-indexing;
                    index-progress: root.search-index-progress;

                    execute => { root.search-execute(); }
                    index-directory => { root.search-index-directory(); }
                    index-pak => { root.search-index-pak(); }
                    clear-index => { root.search-clear-index(); }
                }
            }

            Tab {
                title: "UUID Generator";

                UuidGeneratorTab {
                    last-uuid: root.last-uuid;
                    last-handle: root.last-handle;
                    uuid-history: root.uuid-history;
                    handle-history: root.handle-history;
                    copy-status: root.copy-status;

                    generate-uuid => { root.uuid-generate(); }
                    generate-handle => { root.handle-generate(); }
                    copy(value) => { root.copy-to-clipboard(value); }
                    export-history => { root.uuid-export-history(); }
                    clear-history => { root.uuid-clear-history(); }
                }
            }
        }
    }

    // Error dialog overlay
    if root.show-error : Rectangle {
        background: #00000088;

        TouchArea {
            clicked => { root.show-error = false; }
        }

        Rectangle {
            width: 450px;
            height: 220px;
            background: white;
            border-radius: 12px;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000044;

            TouchArea {}  // Prevent clicks from passing through

            VerticalBox {
                padding: 24px;
                spacing: 16px;

                HorizontalBox {
                    spacing: 12px;

                    Text {
                        text: "‚ö†";
                        font-size: 24px;
                    }

                    Text {
                        text: "Error";
                        font-size: 20px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }
                }

                Text {
                    text: root.error-message;
                    wrap: word-wrap;
                    font-size: 14px;
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }

                    Button {
                        text: "OK";
                        clicked => { root.show-error = false; }
                        primary: true;
                    }
                }
            }
        }
    }

    // About dialog
    AboutDialog {
        dialog-visible: root.show-about;
        version: root.app-version;
        close => { root.show-about = false; }
    }
}
