import { Button, VerticalBox, HorizontalBox, TabWidget } from "std-widgets.slint";

// Import components
import { FileEntry } from "components/common.slint";
import { AssetBrowserTab } from "tabs/asset_browser.slint";
import { UniversalEditorTab } from "tabs/universal_editor.slint";
import { PakOperationsTab } from "tabs/pak_operations.slint";
import { IndexSearchTab } from "tabs/index_search.slint";
import { UuidGeneratorTab } from "tabs/uuid_generator.slint";
import { AboutDialog } from "dialogs/about.slint";

// Re-export FileEntry for Rust code
export { FileEntry }

// ============================================================================
// Main Application Window
// ============================================================================
export component MacPakApp inherits Window {
    title: "MacPak - BG3 Modding Toolkit";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;

    // Application info
    in-out property <string> app-version: "0.1.0";

    // Tab state
    in-out property <int> current-tab: 0;

    // Error dialog
    in-out property <bool> show-error: false;
    in-out property <string> error-message: "";

    // About dialog
    in-out property <bool> show-about: false;

    // Asset Browser state
    in-out property <string> browser-path: "";
    in-out property <[FileEntry]> browser-files: [];
    in-out property <int> browser-selected: -1;
    in-out property <string> browser-search-text: "";
    in-out property <int> browser-type-filter: 0;
    in-out property <bool> browser-filter-pak: false;
    in-out property <bool> browser-filter-larian: false;
    in-out property <bool> browser-filter-images: false;
    in-out property <bool> browser-filter-models: false;
    in-out property <bool> browser-filter-scripts: false;
    in-out property <bool> browser-filter-audio: false;
    in-out property <bool> browser-filter-effects: false;
    in-out property <int> browser-file-count: 0;
    in-out property <int> browser-folder-count: 0;
    in-out property <int> browser-visible-count: 0;
    in-out property <string> browser-total-size: "0 B";
    in-out property <string> browser-preview-content: "";
    in-out property <string> browser-preview-name: "";
    in-out property <string> browser-preview-info: "";
    in-out property <bool> browser-context-menu-visible: false;
    in-out property <length> browser-context-menu-x: 0px;
    in-out property <length> browser-context-menu-y: 0px;
    in-out property <string> browser-context-menu-file-path: "";
    in-out property <string> browser-context-menu-file-type: "";
    in-out property <bool> browser-context-menu-is-dir: false;

    // Editor state
    in-out property <string> editor-file-path: "";
    in-out property <string> editor-content: "";
    in-out property <bool> editor-modified: false;
    in-out property <bool> editor-converting: false;
    in-out property <string> editor-format: "";
    in-out property <string> editor-status: "";

    // Editor search state
    in-out property <bool> editor-search-visible: false;
    in-out property <string> editor-search-text: "";
    in-out property <string> editor-replace-text: "";
    in-out property <bool> editor-search-case-sensitive: false;
    in-out property <bool> editor-search-whole-words: false;
    in-out property <bool> editor-search-use-regex: false;
    in-out property <int> editor-search-match-count: 0;
    in-out property <int> editor-search-current-match: 0;
    in-out property <string> editor-search-status: "";

    // PAK Operations state
    in-out property <string> pak-extract-source: "";
    in-out property <string> pak-extract-dest: "";
    in-out property <float> pak-extract-progress: 0.0;
    in-out property <bool> pak-is-extracting: false;
    in-out property <string> pak-extract-status: "";

    in-out property <string> pak-create-source: "";
    in-out property <string> pak-create-dest: "";
    in-out property <float> pak-create-progress: 0.0;
    in-out property <bool> pak-is-creating: false;
    in-out property <string> pak-create-status: "";

    in-out property <string> pak-list-source: "";
    in-out property <bool> pak-is-listing: false;
    in-out property <[string]> pak-list-contents: [];

    // Search state
    in-out property <string> search-query: "";
    in-out property <bool> search-is-searching: false;
    in-out property <[string]> search-results: [];
    in-out property <string> search-status: "";
    in-out property <int> search-indexed-files: 0;
    in-out property <int> search-indexed-paks: 0;
    in-out property <bool> search-is-indexing: false;
    in-out property <float> search-index-progress: 0.0;

    // UUID Generator state
    in-out property <string> last-uuid: "";
    in-out property <string> last-handle: "";
    in-out property <[string]> uuid-history: [];
    in-out property <[string]> handle-history: [];
    in-out property <string> copy-status: "";

    // Callbacks
    callback tab-changed(int);

    // Browser callbacks
    callback browser-open-folder();
    callback browser-go-up();
    callback browser-go-to-path(string);
    callback browser-refresh();
    callback browser-clear-cache();
    callback browser-file-selected(int);
    callback browser-file-double-clicked(int);
    callback browser-search-changed(string);
    callback browser-filter-changed(int);
    callback browser-toggle-filter(string);
    callback browser-copy-path(string);
    callback browser-show-in-finder(string);
    callback browser-open-in-editor(string);
    callback browser-quick-convert(string, string);
    callback browser-context-menu-action(string, string);

    // Editor callbacks
    callback editor-open();
    callback editor-save();
    callback editor-save-as();
    callback editor-convert(string);
    callback editor-content-changed(string);

    // Editor search callbacks
    callback editor-toggle-search();
    callback editor-find-next();
    callback editor-find-previous();
    callback editor-replace-current();
    callback editor-replace-all();
    callback editor-search-text-changed(string);

    // PAK callbacks
    callback pak-browse-extract-source();
    callback pak-browse-extract-dest();
    callback pak-extract();
    callback pak-browse-create-source();
    callback pak-browse-create-dest();
    callback pak-create();
    callback pak-browse-list-source();
    callback pak-list();

    // Search callbacks
    callback search-execute();
    callback search-index-directory();
    callback search-index-pak();
    callback search-clear-index();

    // UUID callbacks
    callback uuid-generate();
    callback handle-generate();
    callback copy-to-clipboard(string);
    callback uuid-export-history();
    callback uuid-clear-history();

    // Menu callbacks
    callback show-settings();
    callback show-about-dialog();

    VerticalBox {
        padding: 0px;

        TabWidget {
            current-index <=> root.current-tab;

            Tab {
                title: "Asset Browser";

                AssetBrowserTab {
                    current-path <=> root.browser-path;
                    files: root.browser-files;
                    selected-index <=> root.browser-selected;
                    search-text <=> root.browser-search-text;
                    type-filter-index <=> root.browser-type-filter;
                    filter-pak <=> root.browser-filter-pak;
                    filter-larian <=> root.browser-filter-larian;
                    filter-images <=> root.browser-filter-images;
                    filter-models <=> root.browser-filter-models;
                    filter-scripts <=> root.browser-filter-scripts;
                    filter-audio <=> root.browser-filter-audio;
                    filter-effects <=> root.browser-filter-effects;
                    file-count: root.browser-file-count;
                    folder-count: root.browser-folder-count;
                    visible-count: root.browser-visible-count;
                    total-size: root.browser-total-size;
                    preview-content: root.browser-preview-content;
                    preview-file-name: root.browser-preview-name;
                    preview-file-info: root.browser-preview-info;
                    context-menu-visible <=> root.browser-context-menu-visible;
                    context-menu-x <=> root.browser-context-menu-x;
                    context-menu-y <=> root.browser-context-menu-y;
                    context-menu-file-path <=> root.browser-context-menu-file-path;
                    context-menu-file-type <=> root.browser-context-menu-file-type;
                    context-menu-is-dir <=> root.browser-context-menu-is-dir;

                    open-folder => { root.browser-open-folder(); }
                    go-up => { root.browser-go-up(); }
                    go-to-path(path) => { root.browser-go-to-path(path); }
                    refresh => { root.browser-refresh(); }
                    clear-cache => { root.browser-clear-cache(); }
                    file-selected(idx) => { root.browser-file-selected(idx); }
                    file-double-clicked(idx) => { root.browser-file-double-clicked(idx); }
                    search-changed(text) => { root.browser-search-changed(text); }
                    filter-changed(idx) => { root.browser-filter-changed(idx); }
                    toggle-filter(filter) => { root.browser-toggle-filter(filter); }
                    copy-path(path) => { root.browser-copy-path(path); }
                    show-in-finder(path) => { root.browser-show-in-finder(path); }
                    open-in-editor(path) => { root.browser-open-in-editor(path); }
                    quick-convert(path, conv) => { root.browser-quick-convert(path, conv); }
                    context-menu-action(action, path) => { root.browser-context-menu-action(action, path); }
                }
            }

            Tab {
                title: "Universal Editor";

                UniversalEditorTab {
                    file-path: root.editor-file-path;
                    content: root.editor-content;
                    modified: root.editor-modified;
                    converting: root.editor-converting;
                    file-format: root.editor-format;
                    status-message: root.editor-status;

                    // Search state bindings
                    search-visible <=> root.editor-search-visible;
                    search-text <=> root.editor-search-text;
                    replace-text <=> root.editor-replace-text;
                    search-case-sensitive <=> root.editor-search-case-sensitive;
                    search-whole-words <=> root.editor-search-whole-words;
                    search-use-regex <=> root.editor-search-use-regex;
                    search-match-count: root.editor-search-match-count;
                    search-current-match: root.editor-search-current-match;
                    search-status: root.editor-search-status;

                    open => { root.editor-open(); }
                    save => { root.editor-save(); }
                    save-as => { root.editor-save-as(); }
                    convert(format) => { root.editor-convert(format); }
                    content-changed(text) => { root.editor-content-changed(text); }

                    // Search callbacks
                    toggle-search => { root.editor-toggle-search(); }
                    find-next => { root.editor-find-next(); }
                    find-previous => { root.editor-find-previous(); }
                    replace-current => { root.editor-replace-current(); }
                    replace-all => { root.editor-replace-all(); }
                    search-text-changed(text) => { root.editor-search-text-changed(text); }
                }
            }

            Tab {
                title: "PAK Operations";

                PakOperationsTab {
                    extract-source: root.pak-extract-source;
                    extract-dest: root.pak-extract-dest;
                    extract-progress: root.pak-extract-progress;
                    is-extracting: root.pak-is-extracting;
                    extract-status: root.pak-extract-status;

                    create-source: root.pak-create-source;
                    create-dest: root.pak-create-dest;
                    create-progress: root.pak-create-progress;
                    is-creating: root.pak-is-creating;
                    create-status: root.pak-create-status;

                    list-source: root.pak-list-source;
                    is-listing: root.pak-is-listing;
                    list-contents: root.pak-list-contents;

                    browse-extract-source => { root.pak-browse-extract-source(); }
                    browse-extract-dest => { root.pak-browse-extract-dest(); }
                    extract => { root.pak-extract(); }
                    browse-create-source => { root.pak-browse-create-source(); }
                    browse-create-dest => { root.pak-browse-create-dest(); }
                    create => { root.pak-create(); }
                    browse-list-source => { root.pak-browse-list-source(); }
                    list => { root.pak-list(); }
                }
            }

            Tab {
                title: "Index Search";

                IndexSearchTab {
                    query: root.search-query;
                    is-searching: root.search-is-searching;
                    results: root.search-results;
                    status: root.search-status;
                    indexed-files: root.search-indexed-files;
                    indexed-paks: root.search-indexed-paks;
                    is-indexing: root.search-is-indexing;
                    index-progress: root.search-index-progress;

                    execute => { root.search-execute(); }
                    index-directory => { root.search-index-directory(); }
                    index-pak => { root.search-index-pak(); }
                    clear-index => { root.search-clear-index(); }
                }
            }

            Tab {
                title: "UUID Generator";

                UuidGeneratorTab {
                    last-uuid: root.last-uuid;
                    last-handle: root.last-handle;
                    uuid-history: root.uuid-history;
                    handle-history: root.handle-history;
                    copy-status: root.copy-status;

                    generate-uuid => { root.uuid-generate(); }
                    generate-handle => { root.handle-generate(); }
                    copy(value) => { root.copy-to-clipboard(value); }
                    export-history => { root.uuid-export-history(); }
                    clear-history => { root.uuid-clear-history(); }
                }
            }
        }
    }

    // Error dialog overlay
    if root.show-error : Rectangle {
        background: #00000088;

        TouchArea {
            clicked => { root.show-error = false; }
        }

        Rectangle {
            width: 450px;
            height: 220px;
            background: white;
            border-radius: 12px;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000044;

            TouchArea {}  // Prevent clicks from passing through

            VerticalBox {
                padding: 24px;
                spacing: 16px;

                HorizontalBox {
                    spacing: 12px;

                    Text {
                        text: "âš ";
                        font-size: 24px;
                    }

                    Text {
                        text: "Error";
                        font-size: 20px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }
                }

                Text {
                    text: root.error-message;
                    wrap: word-wrap;
                    font-size: 14px;
                }

                Rectangle { vertical-stretch: 1; }

                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }

                    Button {
                        text: "OK";
                        clicked => { root.show-error = false; }
                        primary: true;
                    }
                }
            }
        }
    }

    // About dialog
    AboutDialog {
        dialog-visible: root.show-about;
        version: root.app-version;
        close => { root.show-about = false; }
    }
}
